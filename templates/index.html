<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –ò–ò</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .poem-card { transition: 0.3s; border-left: 5px solid transparent; }
        .poem-card.read { border-left-color: #28a745; opacity: 0.8; }
        .poem-card.pinned { border-left-color: #ffc107; background: #fffdf5; }
        .chat-box { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 500px; display: none; z-index: 1000; }
        #chat-content { height: 350px; overflow-y: auto; background: #fdfdfd; padding: 15px; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">PoetryAI Beta</a>
            <div>
                <a href="/profile" class="btn btn-outline-light btn-sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
                <a href="/logout" class="btn btn-danger btn-sm">–í—ã—Ö–æ–¥</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            {% for poem in poems %}
            <div class="col-md-6 mb-4">
                <div class="card poem-card shadow-sm {% if poem.title in read_list %}read{% endif %} {% if poem.title == pinned %}pinned{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">{{ poem.title }} {% if poem.title == pinned %}üìå{% endif %}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ poem.author }}</h6>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" onclick="startChat({{ poem.id }}, '{{ poem.title }}')">–ß–∞—Ç —Å –∫—Ä–∏—Ç–∏–∫–æ–º</button>
                            <button class="btn btn-outline-success btn-sm" onclick="markRead('{{ poem.title }}')">‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</button>
                            <button class="btn btn-outline-warning btn-sm" onclick="pinPoem('{{ poem.title }}')">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="aiChat" class="card chat-box shadow-lg">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <span id="activePoemTitle">–ö—Ä–∏—Ç–∏–∫</span>
            <button onclick="document.getElementById('aiChat').style.display='none'" class="btn-close btn-close-white"></button>
        </div>
        <div id="chat-content"></div>
        <div class="card-footer">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ —Å–º—ã—Å–ª–µ...">
                <button class="btn btn-primary" onclick="sendToAI()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentPoemId = null;

        function startChat(id, title) {
            currentPoemId = id;
            document.getElementById('activePoemTitle').innerText = title;
            document.getElementById('aiChat').style.display = 'flex';
            document.getElementById('chat-content').innerHTML = `<div class="text-muted small">–í—ã –æ–±—Å—É–∂–¥–∞–µ—Ç–µ: ${title}. –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–æ–≤–µ–¥—É.</div>`;
        }

        async function sendToAI() {
            const input = document.getElementById('chatInput');
            const content = document.getElementById('chat-content');
            const q = input.value;
            if(!q) return;

            content.innerHTML += `<div class="mb-2 text-end"><b>–í—ã:</b> <br>${q}</div>`;
            input.value = '';

            const res = await fetch('/poems/ask', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({poem_id: currentPoemId, question: q})
            });
            const data = await res.json();
            content.innerHTML += `<div class="mb-2 bg-light p-2 rounded"><b>–ö—Ä–∏—Ç–∏–∫:</b> <br>${data.answer}</div>`;
            content.scrollTop = content.scrollHeight;
        }

        async function markRead(title) {
            await fetch('/poems/toggle_read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title})
            });
            location.reload();
        }

        async function pinPoem(title) {
            await fetch('/poems/toggle_pin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title})
            });
            location.reload();
        }
    </script>
</body>
                </html>
    
