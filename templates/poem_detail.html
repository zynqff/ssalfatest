{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3 border-end" style="height: 80vh; overflow-y: auto;">
            <h5>История обсуждения</h5>
            <div class="list-group list-group-flush">
                {% for msg in chat_history if msg.role == 'user' %}
                    <div class="list-group-item list-group-item-action small text-truncate">
                        {{ msg.content }}
                    </div>
                {% else %}
                    <p class="text-muted small">Здесь появятся ваши вопросы</p>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-9">
            <h2>{{ poem.title }}</h2>
            <p class="text-muted">{{ poem.author }}</p>
            <pre class="poem-text" style="white-space: pre-wrap;">{{ poem.content }}</pre>

            <hr>

            <div id="chat-window" class="mb-3" style="height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                {% for msg in chat_history %}
                    <div class="mb-2 {{ 'text-end' if msg.role == 'user' else '' }}">
                        <span class="badge {{ 'bg-primary' if msg.role == 'user' else 'bg-secondary' }}">
                            {{ 'Вы' if msg.role == 'user' else 'ИИ' }}
                        </span>
                        <div class="p-2 d-inline-block rounded {{ 'bg-light border' if msg.role == 'user' else 'bg-white shadow-sm' }}" style="max-width: 80%;">
                            {{ msg.content }}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="input-group mb-3">
                <input type="text" id="user-question" class="form-control" placeholder="Задайте вопрос по стиху...">
                <button class="btn btn-primary" onclick="askAI()">Отправить</button>
            </div>
        </div>
    </div>
</div>

<script>
async def askAI() {
    const question = document.getElementById('user-question').value;
    const chatWindow = document.getElementById('chat-window');
    
    // Добавляем сообщение пользователя визуально
    chatWindow.innerHTML += `<div class="text-end mb-2"><span class="badge bg-primary">Вы</span><div class="p-2 d-inline-block bg-light border rounded">${question}</div></div>`;
    document.getElementById('user-question').value = '';

    const response = await fetch('/ai-ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({question: question, poem_id: {{ poem.id }}})
    });
    
    const data = await response.json();
    
    // Добавляем ответ ИИ
    chatWindow.innerHTML += `<div class="mb-2"><span class="badge bg-secondary">ИИ</span><div class="p-2 d-inline-block bg-white shadow-sm rounded">${data.answer}</div></div>`;
    chatWindow.scrollTop = chatWindow.scrollHeight;
}
</script>
{% endblock %}
                    
