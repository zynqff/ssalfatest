{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- –ü–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ -->
        <div class="col-md-3 border-end" style="height: 80vh; overflow-y: auto;">
            <h5>–í—Å–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</h5>
            {% if user %}
            <div class="list-group list-group-flush">
                {% for session in all_user_sessions %}
                    <a href="/poem/{{ session.poem_id }}" class="list-group-item list-group-item-action {% if session.id == session_id %}active{% endif %}">
                        <strong class="d-block text-truncate {% if session.id == session_id %}text-white{% endif %}">{{ session.poem.title }}</strong>
                        <div class="small opacity-75">–æ—Ç {{ session.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                    </a>
                {% else %}
                    <p class="text-muted small p-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏–π.</p>
                {% endfor %}
            </div>
            {% else %}
                <p class="text-muted small p-2">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</p>
            {% endif %}
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å–æ —Å—Ç–∏—Ö–æ–º –∏ —á–∞—Ç–æ–º -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 id="poem-title">{{ poem.title }}</h2>
                    <p class="text-muted mb-2" id="poem-author">{{ poem.author }}</p>
                </div>
                {% if user %}
                <a href="/poem/{{ poem.id }}?new_chat=true" class="btn btn-sm btn-outline-info">üöÄ –ù–æ–≤—ã–π —á–∞—Ç</a>
                {% endif %}
            </div>
            <pre class="poem-text" style="white-space: pre-wrap;">{{ poem.content }}</pre>
            <hr class="opacity-50">

            <h4 id="chat-title" class="mb-3" style="color: var(--accent);">
                –û–±—Å—É–∂–¥–µ–Ω–∏–µ –æ—Ç {{ current_chat_history[0].session.created_at.strftime('%d.%m.%Y %H:%M') if current_chat_history else '—Å–µ–π—á–∞—Å' }}
            </h4>
            <div id="chat-window" class="mb-3 p-3" style="height: 400px; overflow-y: auto; background: rgba(13,17,23,0.7); border: 1px solid var(--border); border-radius: 20px;">
                {% for msg in current_chat_history %}
                    <div class="mb-2 {{ 'text-end' if msg.role == 'user' else '' }}">
                        <div class="p-2 d-inline-block rounded-3" style="max-width: 80%; background: {{ 'rgba(0, 212, 255, 0.1)' if msg.role == 'user' else 'rgba(255, 255, 255, 0.05)' }}; border: 1px solid {{ 'rgba(0, 212, 255, 0.2)' if msg.role == 'user' else 'var(--border)' }};">
                            <div class="small fw-bold mb-1" style="color: {{ 'var(--accent)' if msg.role == 'user' else 'var(--secondary)' }}">{{ '–í—ã' if msg.role == 'user' else 'Poetry AI' }}</div>
                            <div class="chat-content">{{ msg.content | safe }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div id="chat-input-container" class="input-group">
                <input type="text" id="user-question" class="form-control" placeholder="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ..." style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; border-radius: 15px 0 0 15px; padding: 12px;" {% if not user %}disabled{% endif %}>
                <button class="btn btn-custom" onclick="askAI()" style="border-radius: 0 15px 15px 0;" {% if not user %}disabled{% endif %}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% if user %}
<script>
let currentSessionId = "{{ session_id }}";
const converter = new showdown.Converter({ simpleLineBreaks: true, tables: true });

function renderContent(element) {
    const elementsToRender = element ? element.querySelectorAll('.chat-content:not([data-rendered])') : document.querySelectorAll('.chat-content');
    elementsToRender.forEach((el) => {
        el.innerHTML = converter.makeHtml(el.innerHTML);
        el.dataset.rendered = 'true';
    });
    renderMathInElement(element || document.body, {
        delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
    });
}

async function askAI() {
    const questionInput = document.getElementById('user-question');
    const question = questionInput.value;
    if (!question || !currentSessionId) return;

    const chatWindow = document.getElementById('chat-window');
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMsgContainer = document.createElement('div');
    userMsgContainer.className = 'mb-2 text-end';
    userMsgContainer.innerHTML = `<div class="p-2 d-inline-block rounded-3" style="max-width: 80%; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2);">
            <div class="small fw-bold mb-1" style="color: var(--accent)">–í—ã</div>
            <div class="chat-content">${question}</div>
        </div>`;
    chatWindow.appendChild(userMsgContainer);
    questionInput.value = '';
    chatWindow.scrollTop = chatWindow.scrollHeight;
    renderContent(userMsgContainer);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ò–ò
    const aiMsgContainer = document.createElement('div');
    aiMsgContainer.className = 'mb-2';
    aiMsgContainer.innerHTML = `<div class="p-2 d-inline-block rounded-3" style="max-width: 80%; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);">
            <div class="small fw-bold mb-1" style="color: var(--secondary)">Poetry AI</div>
            <div class="chat-content"></div>
    </div>`;
    chatWindow.appendChild(aiMsgContainer);
    const aiContentDiv = aiMsgContainer.querySelector('.chat-content');

    // –ù–∞—á–∏–Ω–∞–µ–º —Å—Ç—Ä–∏–º–∏–Ω–≥
    const response = await fetch('/ai-ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({question: question, session_id: currentSessionId})
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        aiContentDiv.innerHTML += chunk;
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º Markdown –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
    renderContent(aiMsgContainer);
}

// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => renderContent());

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è Enter
document.getElementById('user-question').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        askAI();
    }
});
</script>
{% endif %}
{% endblock %}